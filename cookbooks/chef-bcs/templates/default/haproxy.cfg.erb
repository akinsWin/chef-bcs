################################################
# Auto generated
################################################

global
  daemon
  user haproxy
  group haproxy
  pidfile /var/run/haproxy.pid
  #stats socket /var/run/haproxy/haproxy.asok level admin
  log /dev/log local0 info
  maxconn <%= node['chef-bcs']['adc']['connections']['max'] %>

defaults
  log global
  mode http
  option http-server-close
  option abortonclose
  option tcplog
  option dontlognull
  option nolinger
  option redispatch
  retries 3
  timeout http-request 5s
  timeout queue 1m
  timeout connect 5s
  timeout check 10s
  timeout client 30m
  timeout server 30m

<% if node['chef-bcs']['adc']['stats']['enable'] %>
# Only want the real IP and not the VIPs
listen stats <%= @server['network']['public']['ip'] %>:<%= node['chef-bcs']['adc']['stats']['port'] %>
    stats enable
    stats uri /
    stats hide-version
    stats auth <%= node['chef-bcs']['adc']['stats']['user'] %>:<%= node['chef-bcs']['adc']['stats']['passwd'] %>
<% end -%>

<% node['chef-bcs']['adc']['vips'].each do | vip | %>
frontend radosgw-http-<%="#{vip['name']}"%>
  bind <%="#{vip['ip']}:#{node['chef-bcs']['adc']['vip']['port']['non_ssl']}"%>
  option tcplog
  default_backend radosgw-http-backend

#frontend radosgw-https-<%="#{vip['name']}"%>
#  bind <%="#{vip['ip']}:#{node['chef-bcs']['adc']['vip']['port']['ssl']}"%> ssl crt <%="#{node['chef-bcs']['adc']['ssl']['path']}/#{node['chef-bcs']['adc']['ssl']['path']}" %>
#  option tcplog
#  default_backend radosgw-http-backend

<% end %>

# NOTE: Could try to have a vip related backend since vips represent network tiers. Try to have a different instance
# Actually, using a different port per rgw instance would work.
backend radosgw-http-backend
  balance <%= node['chef-bcs']['adc']['connections']['balance'] %>
  option httpchk GET /
  http-check expect status 200
<% @backend_nodes.each do | backend_node | -%>
  <%= "server #{backend_node['name']} #{backend_node['ip']}:#{node['chef-bcs']['adc']['backend']['port']} weight #{backend_node['weight']} #{backend_node['options']}" %>
<% end -%>
